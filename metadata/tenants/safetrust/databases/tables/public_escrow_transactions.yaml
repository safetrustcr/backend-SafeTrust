table:
  name: escrow_transactions
  schema: public
  columns:
    - name: id
      type: uuid
    - name: bid_request_id
      type: uuid
    - name: engagement_id
      type: text
    - name: contract_id
      type: text
    - name: signer_address
      type: text
    - name: transaction_type
      type: escrow_transaction_type
    - name: status
      type: escrow_status
    - name: http_status_code
      type: integer
    - name: http_response_body
      type: jsonb
    - name: http_error_details
      type: jsonb
    - name: amount
      type: numeric
    - name: initial_deposit_percentage
      type: integer
    - name: cancellation_reason
      type: text
    - name: cancelled_by
      type: text
    - name: refund_status
      type: escrow_status
    - name: metadata
      type: jsonb
    - name: created_at
      type: timestamptz
    - name: updated_at
      type: timestamptz
    - name: completed_at
      type: timestamptz
    - name: total_amount
      type: numeric
    - name: activated_at
      type: timestamptz
    - name: released_at
      type: timestamptz
    - name: blockchain_tx_hash
      type: text
  object_relationships:
    - name: bid_request
      using:
        foreign_key_constraint_on: bid_request_id
    - name: cancelled_by_user
      using:
        foreign_key_constraint_on: cancelled_by
  array_relationships:
    - name: xdr_transactions
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: escrow_xdr_transactions
    - name: api_calls
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: escrow_api_calls
    - name: escrow_transaction_users
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: escrow_transaction_users
    - name: escrow_transaction_users_aggregate
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: escrow_transaction_users
    - name: conditions
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: escrow_conditions
    - name: escrow_conditions
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: escrow_conditions
    - name: escrow_conditions_aggregate
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: escrow_conditions
    - name: notifications
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: notifications
    - name: blockchain_transactions
      using:
        foreign_key_constraint_on:
          column: escrow_transaction_id
          table: blockchain_transactions
select_permissions:
  - role: anonymous
    permission:
      columns: []
      filter: {}
    comment: "Anonymous users cannot access escrow transactions"
  - role: user
    permission:
      columns:
        - id
        - bid_request_id
        - engagement_id
        - contract_id
        - transaction_type
        - status
        - amount
        - initial_deposit_percentage
        - refund_status
        - created_at
        - updated_at
        - completed_at
      filter:
        _and:
          # Tenant isolation: must match user's tenant
          - bid_request:
              apartment:
                owner_id:
                  _neq: ""
          # Row-level security: user must be participant
          - _or:
              # User is the tenant (bid maker)
              - bid_request:
                  tenant_id:
                    _eq: X-Hasura-User-Id
              # User is the apartment owner
              - bid_request:
                  apartment:
                    owner_id:
                      _eq: X-Hasura-User-Id
              # User cancelled the escrow
              - cancelled_by:
                  _eq: X-Hasura-User-Id
      comment: "Users can only see escrows where they are participants within their tenant"
  - role: admin
    permission:
      columns: "*"
      filter:
        bid_request:
          apartment:
            owner_id:
              _neq: ""
      comment: "Admins can view all escrows in their tenant"
insert_permissions:
  - role: user
    permission:
      check:
        _and:
          # Tenant isolation check
          - bid_request:
              tenant_id:
                _eq: X-Hasura-User-Id
          # User can only create escrows for their own bid requests
          - bid_request:
              tenant_id:
                _eq: X-Hasura-User-Id
      columns:
        - bid_request_id
        - engagement_id
        - contract_id
        - signer_address
        - transaction_type
        - status
        - amount
        - initial_deposit_percentage
        - metadata
      set:
        # Automatically set creator information
        created_at: now
      comment: "Users can create escrows for their bid requests in their tenant"
  - role: admin
    permission:
      check:
        bid_request:
          apartment:
            owner_id:
              _neq: ""
      columns:
        - bid_request_id
        - engagement_id
        - contract_id
        - signer_address
        - transaction_type
        - status
        - amount
        - initial_deposit_percentage
        - http_status_code
        - http_response_body
        - http_error_details
        - metadata
      comment: "Admins can create and manage escrows in their tenant"
update_permissions:
  - role: user
    permission:
      columns:
        - status
        - refund_status
        - cancellation_reason
      filter:
        _and:
          # Tenant isolation
          - bid_request:
              tenant_id:
                _eq: X-Hasura-User-Id
          # User can only update their own escrows
          - bid_request:
              tenant_id:
                _eq: X-Hasura-User-Id
      check:
        _and:
          - bid_request:
              tenant_id:
                _eq: X-Hasura-User-Id
      comment: "Users can only update status/refund info for their own escrows"
  - role: admin
    permission:
      columns:
        - status
        - refund_status
        - cancellation_reason
        - cancelled_by
        - http_status_code
        - http_response_body
        - http_error_details
        - updated_at
      filter:
        bid_request:
          apartment:
            owner_id:
              _neq: ""
      check:
        bid_request:
          apartment:
            owner_id:
              _neq: ""
      comment: "Admins can update all escrow properties and verify conditions in their tenant"
delete_permissions:
  - role: admin
    permission:
      filter:
        bid_request:
          apartment:
            owner_id:
              _neq: ""
      comment: "Admins can delete escrows in their tenant"
event_triggers:
  - name: on_escrow_created
    definition:
      enable_manual: true
      insert:
        columns: "*"
    retry_conf:
      interval_sec: 10
      num_retries: 3
      timeout_sec: 60
    webhook: "{{WEBHOOK_URL}}/events/escrow-created"
    headers:
      - name: x-hasura-admin-secret
        value_from_env: HASURA_GRAPHQL_ADMIN_SECRET
  - name: on_fund_released
    definition:
      enable_manual: true
      update:
        columns:
          - status
        condition:
          status:
            _eq: "released"
    retry_conf:
      interval_sec: 10
      num_retries: 3
      timeout_sec: 60
    webhook: "{{WEBHOOK_URL}}/events/fund-released"
    headers:
      - name: x-hasura-admin-secret
        value_from_env: HASURA_GRAPHQL_ADMIN_SECRET
  - name: on_refund_requested
    definition:
      enable_manual: true
      update:
        columns:
          - refund_status
          - cancellation_reason
          - cancelled_by
        condition:
          _or:
            - refund_status:
                _is_null: false
            - cancellation_reason:
                _is_null: false
    retry_conf:
      interval_sec: 10
      num_retries: 3
      timeout_sec: 60
    webhook: "{{WEBHOOK_URL}}/events/refund-requested"
    headers:
      - name: x-hasura-admin-secret
        value_from_env: HASURA_GRAPHQL_ADMIN_SECRET
