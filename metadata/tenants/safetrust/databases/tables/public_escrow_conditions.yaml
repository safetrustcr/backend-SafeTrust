table:
  name: escrow_conditions
  schema: public
object_relationships:
  - name: escrow_transaction
    using:
      foreign_key_constraint_on: escrow_transaction_id
  - name: verifier
    using:
      foreign_key_constraint_on: verified_by
array_relationships:
  - name: escrow_conditions_aggregate
    using:
      foreign_key_constraint_on:
        column: escrow_transaction_id
        table: escrow_transactions
select_permissions:
  - role: user
    permission:
      columns:
        - id
        - escrow_transaction_id
        - condition_type
        - description
        - status
        - verified_at
        - verified_by
        - metadata
        - created_at
        - updated_at
      filter:
        escrow_transaction:
          escrow_transaction_users:
            user_id:
              _eq: X-Hasura-User-Id
      allow_aggregations: true
    comment: "Users can see conditions for escrows they're part of"
  - role: landlord
    permission:
      columns:
        - id
        - escrow_transaction_id
        - condition_type
        - description
        - status
        - verified_at
        - verified_by
        - metadata
        - created_at
        - updated_at
      filter:
        escrow_transaction:
          escrow_transaction_users:
            user_id:
              _eq: X-Hasura-User-Id
      allow_aggregations: true
    comment: "Landlords can see conditions for their escrows"
  - role: tenant
    permission:
      columns:
        - id
        - escrow_transaction_id
        - condition_type
        - description
        - status
        - verified_at
        - verified_by
        - metadata
        - created_at
        - updated_at
      filter:
        escrow_transaction:
          escrow_transaction_users:
            user_id:
              _eq: X-Hasura-User-Id
      allow_aggregations: true
    comment: "Tenants can see conditions for their escrows"
update_permissions:
  - role: user
    permission:
      filter:
        escrow_transaction:
          escrow_transaction_users:
            user_id:
              _eq: X-Hasura-User-Id
            role:
              _in:
                - arbitrator
                - admin
      columns:
        - status
        - verified_at
        - verified_by
        - metadata
      check:
        escrow_transaction:
          escrow_transaction_users:
            user_id:
              _eq: X-Hasura-User-Id
            role:
              _in:
                - arbitrator
                - admin
    comment: "Only arbitrators/admins can verify conditions"
